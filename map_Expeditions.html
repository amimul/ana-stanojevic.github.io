<!DOCTYPE html>
<meta charset="utf-8">

<!-- Set a style for our worldshape-data -->
  <style>
  path {
    stroke: lightRed;
    stroke-width: 0.5px;
    fill: grey;
  }
  .container {
    width: 100%;
  }

  .line {
    fill: none;
    stroke: steelblue;
    stroke-width: 1.5;
    shape-rendering: crispEdges;
    stroke-linejoin: round;
    stroke-linecap: round;
  }
  svg {
  background: lightBlue;
}
html, body {
    max-width: 100% !important;
    overflow-x: hidden !important;
}
html, body {
    max-height: 100% !important;
    overflow-y: hidden !important;
}

  </style>
<body>

  <!-- implementation of the hosted D3- and TopoJson js-libraries -->
  <script src="http://d3js.org/d3.v4.min.js"></script>
  <script src="http://d3js.org/topojson.v0.min.js"></script>

  <!-- map creation -->
  <script>

  var width = window.innerWidth, height = window.innerHeight;
  const default_scale = 470;

  var expedition_data = null;

  var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);

  var projection = d3.geoEquirectangular()
      .scale(default_scale)
      .translate([width/2+130, height/2-10]);

  var path = d3.geoPath().pointRadius(5).projection(projection);

  let line = d3.line().curve(d3.curveLinear)
               .x(function(d) {
                  long = parseFloat(d.Longitude.replace(',','.').replace(' ',''));
                  lat = parseFloat(d.Latitude.replace(',','.').replace(' ',''));
                  return projection([long, lat])[0];
                })
               .y(function(d) {
                  long = parseFloat(d.Longitude.replace(',','.').replace(' ',''));
                  lat = parseFloat(d.Latitude.replace(',','.').replace(' ',''));
                  return projection([long, lat])[1];
                });

  let zooming = function(d) {

    let offset = [d3.event.transform.x, d3.event.transform.y];
    let scale = d3.event.transform.k*default_scale;

    projection.translate(offset)
              .scale(scale);

    let _g = d3.select("g");

    _g.selectAll("path")
       .attr("d", path);

    if(expedition_data != null) {
      _g.selectAll('.line')
        .datum(expedition_data)
        .attr("d", line);
    }

    //update all circles
    _g.selectAll("circle")
      .attr("cx", function(d){
        long = parseFloat(d.Longitude.replace(',','.').replace(' ',''));
        lat = parseFloat(d.Latitude.replace(',','.').replace(' ',''));
        return projection([long, lat])[0];
      })
      .attr("cy", function(d){
        long = parseFloat(d.Longitude.replace(',','.').replace(' ',''));
        lat = parseFloat(d.Latitude.replace(',','.').replace(' ',''));
        return projection([long, lat])[1];
      });
  }

  let center = projection([-97.0, 39.0]);

  // Define the zoom behavior
  var zoom = d3.zoom().on("zoom", zooming);
  var g = svg.append("g").attr("id", "map")
               .call(zoom)
               .call(zoom.transform,
                      d3.zoomIdentity.translate(width/2, height/2)
                                     .scale(0.5)
                                     .translate(-center[0], -center[1]));

  // load data and display the map on the canvas with country geometries
  d3.json("https://unpkg.com/world-atlas@1/world/110m.json", function(error, topology) {
      g.selectAll("path")
       .data(topojson.object(topology, topology.objects.countries).geometries)
       .enter()
       .append("path")
       .attr("d", path);
  });



  const expedition_csv = "data/expeditions/expedition_01.csv"
  d3.text(expedition_csv, function(error, raw) {
    let dsv = d3.dsvFormat(';')
    let data = dsv.parse(raw);

    if(expedition_data == null) {
      expedition_data = data;
    }

    let _g = d3.select("g");

    _g.selectAll("circle")
      .data(data).enter()
      .append("circle")
      .style("fill", "blue")
      .attr("r", 2)
      .attr("cx", function(d){
        lat = parseFloat(d.Latitude.replace(',','.').replace(' ',''));
        long = parseFloat(d.Longitude.replace(',','.').replace(' ',''));
        return projection([long, lat])[0];
      })
      .attr("cy", function(d){
        lat = parseFloat(d.Latitude.replace(',','.').replace(' ',''));
        long = parseFloat(d.Longitude.replace(',','.').replace(' ',''));
        return projection([long, lat])[1];
      });
    _g.append("path")
      .datum(data)
      .attr("class", "line")
      .attr("d", line);

  });

 
  </script>
     <script>
let allButtons= svg.append("g").attr("id","allButtons") 
let labels= ['Overview','Expeditions','Spreading'];  //here maybe some more creative way
let defaultColor= "#7777BB"
let hoverColor= "#0000ff"
let pressedColor= "#000077"

let buttonGroups= allButtons.selectAll("g.button")
                                  .data(labels)
                                  .enter()
                                  .append("g")
                                  .attr("class","button")
                                  .style("cursor","pointer")
                                  .on("click",function(d,i) {
                                      d3.select(this.parentNode).selectAll("rect").attr("fill",defaultColor)
                                      d3.select(this).select("rect").attr("fill",pressedColor)
                                      var url = 'map_'+d+'.html'
                                      console.log(url)
                                      // $(location).attr('href', url);
                                      window.location.assign(url); 
                                  })
                                  .on("mouseover", function() {
                                      if (d3.select(this).select("rect").attr("fill") != pressedColor) {
                                          d3.select(this)
                                              .select("rect")
                                              .attr("fill",hoverColor);
                                      }
                                  })
                                  .on("mouseout", function() {
                                      if (d3.select(this).select("rect").attr("fill") != pressedColor) {
                                          d3.select(this)
                                              .select("rect")
                                              .attr("fill",defaultColor);
                                      }
                                  })
var bWidth= 100; //button width
var bHeight= 25; //button height
var bSpace= 10; //space between buttons
var x0= 20; //x offset
var y0= window.innerHeight*0.80+5; //y offset
buttonGroups.append("rect")
            .attr("class","buttonRect")
            .attr("width",bWidth)
            .attr("height",bHeight)
            .attr("x",x0)
            .attr("y",function(d,i) {return y0+(bHeight+bSpace)*i;})
            .attr("rx",5) //rx and ry give the buttons rounded corners
            .attr("ry",5)
            .attr("fill",defaultColor)

buttonGroups.append("text")
            .attr("class","buttonText")
            .attr("font-family","FontAwesome")
            .attr("x",x0 + bWidth/2)
            .attr("y",function(d,i) { return y0+ (bHeight+bSpace)*i + bHeight/2; })
            .attr("text-anchor","middle")
            .attr("dominant-baseline","central")
            .attr("fill","white")
            .text(function(d) {return d;})
</script>
</body>
</html>
