<!DOCTYPE html>
<meta charset="utf-8">

<!-- Set a style for our worldshape-data -->
  <style>
  path {
    stroke: red;
    stroke-width: 0.5px;
    fill: grey;
  }
  .container {
    width: 100%;
  }

  .line {
    fill: none;
    stroke: steelblue;
    stroke-width: 1.5;
    shape-rendering: crispEdges;
    stroke-linejoin: round;
    stroke-linecap: round;
  }

  </style>
<body>

  <!-- implementation of the hosted D3- and TopoJson js-libraries -->
  <script src="http://d3js.org/d3.v4.min.js"></script>
  <script src="http://d3js.org/topojson.v0.min.js"></script>

  <!-- map creation -->
  <script>

  var width = 720, height = 500;
  const default_scale = 200;

  var expedition_data = null;

  var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);

  var projection = d3.geoEquirectangular()
      .scale(default_scale)
      .translate([width/2, height/2]);

  var svg = d3.select("body").append("svg")
              .attr("width", width)
              .attr("height", height);


  var path = d3.geoPath().pointRadius(5).projection(projection);

  let line = d3.line().curve(d3.curveLinear)
               .x(function(d) {
                  long = parseFloat(d.Longitude.replace(',','.').replace(' ',''));
                  lat = parseFloat(d.Latitude.replace(',','.').replace(' ',''));
                  return projection([long, lat])[0];
                })
               .y(function(d) {
                  long = parseFloat(d.Longitude.replace(',','.').replace(' ',''));
                  lat = parseFloat(d.Latitude.replace(',','.').replace(' ',''));
                  return projection([long, lat])[1];
                });

  let zooming = function(d) {

    let offset = [d3.event.transform.x, d3.event.transform.y];
    let scale = d3.event.transform.k*default_scale;

    projection.translate(offset)
              .scale(scale);

    let _g = d3.select("g");

    _g.selectAll("path")
       .attr("d", path);

    if(expedition_data != null) {
      _g.selectAll('.line')
        .datum(expedition_data)
        .attr("d", line);
    }

    //update all circles
    _g.selectAll("circle")
      .attr("cx", function(d){
        long = parseFloat(d.Longitude.replace(',','.').replace(' ',''));
        lat = parseFloat(d.Latitude.replace(',','.').replace(' ',''));
        return projection([long, lat])[0];
      })
      .attr("cy", function(d){
        long = parseFloat(d.Longitude.replace(',','.').replace(' ',''));
        lat = parseFloat(d.Latitude.replace(',','.').replace(' ',''));
        return projection([long, lat])[1];
      });
  }

  let center = projection([-97.0, 39.0]);

  // Define the zoom behavior
  var zoom = d3.zoom().on("zoom", zooming);
  var g = svg.append("g").attr("id", "map")
               .call(zoom)
               .call(zoom.transform,
                      d3.zoomIdentity.translate(width/2, height/2)
                                     .scale(0.5)
                                     .translate(-center[0], -center[1]));

  // load data and display the map on the canvas with country geometries
  d3.json("world-110m.json", function(error, topology) {
      g.selectAll("path")
       .data(topojson.object(topology, topology.objects.countries).geometries)
       .enter()
       .append("path")
       .attr("d", path);
  });



  const expedition_csv = "data/expeditions/expedition_01.csv"
  d3.text(expedition_csv, function(error, raw) {
    let dsv = d3.dsvFormat(';')
    let data = dsv.parse(raw);

    if(expedition_data == null) {
      expedition_data = data;
    }

    let _g = d3.select("g");

    _g.selectAll("circle")
      .data(data).enter()
      .append("circle")
      .style("fill", "blue")
      .attr("r", 2)
      .attr("cx", function(d){
        lat = parseFloat(d.Latitude.replace(',','.').replace(' ',''));
        long = parseFloat(d.Longitude.replace(',','.').replace(' ',''));
        return projection([long, lat])[0];
      })
      .attr("cy", function(d){
        lat = parseFloat(d.Latitude.replace(',','.').replace(' ',''));
        long = parseFloat(d.Longitude.replace(',','.').replace(' ',''));
        return projection([long, lat])[1];
      });

    _g.append("path")
      .datum(data)
      .attr("class", "line")
      .attr("d", line);

  });


  // zoom and pan functionality
  /*var zoom = d3.behavior.zoom()
      .on("zoom",function() {
          g.attr("transform","translate("+
              d3.event.translate.join(",")+")scale("+d3.event.scale+")");
          g.selectAll("path")
              .attr("d", path.projection(projection));
    });

  svg.call(zoom)*/

  </script>
</body>
</html>
